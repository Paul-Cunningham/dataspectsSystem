version: "3"
services:
  db:
    image: mariadb:{{ mariadbVersion }}
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: {{ mysql_root_password }}
    volumes:
      - mariadb_data:/var/lib/mysql
  {{ mediawikiDockerServiceName }}:
    image: dataspects/docker-apache-php-dataspects-mediawiki:{{ dockerApachePhpDataspectsMediawikiVersion }}
    volumes:
      - mediawiki_root:/var/www/html/w
      - mediawiki_conf:/etc/apache2/sites-available
  proxy:
    image: dataspects/docker-nginx:{{ dockerNginxVersion }}
    ports:
      - {{ nginxPortOnHost }}:80
    volumes:
      - nginx_conf:/etc/nginx/conf.d
  parsoid:
    image: dataspects/docker-parsoid:{{ dockerParsoidVersion }}
    environment: #AAA
      PARSOID_DOMAIN_{{ mediawikiDomainNameInHostFile }}: http://{{ mediawikiDockerServiceName }}/w/api.php
  elasticsearch:
    # https://github.com/dataspects/docker-elasticsearch/blob/master/Dockerfile
    image: dataspects/docker-elasticsearch:{{ dockerElasticsearchVersion }}
    environment:
      - "ES_JAVA_OPTS=-Xms2048m -Xmx2048m"
      - "discovery.type=single-node"
    volumes:
      - esdata:/usr/share/elasticsearch/data
    ports:
      - {{ elasticsearchPortOnHost }}:9200
  kibana:
    image: kibana:{{ kibanaVersion }}
    environment:
      - "ELASTICSEARCH_URL=http://elasticsearch:9200"
    ports:
      - {{ kibanaPortOnHost }}:5601
  redis:
    image: redis:{{ redisVersion }}
  # tomcat:
  #   image: dataspects/docker-tomcat:1.0
  #   volumes:
  #     - tomcat_root:/usr/local/tomcat/webapps
  tika:
    # https://wiki.apache.org/tika/TikaJAXRS#Using_prebuilt_Docker_image
    image: logicalspark/docker-tikaserver:{{ dockerTikaserverVersion }}
  api:
    image: 550143289598.dkr.ecr.eu-central-1.amazonaws.com/dataspects-webservice:{{ dockerDataspectsWebserviceVersion }}
    ports:
      - {{ dataspectsAPIPortOnHost }}:3000
    environment:
      SIDEKIQ_UI_USERNAME: none
      SIDEKIQ_UI_PASSWORD: none
      API_KEY: none
      REDIS_URL: redis://redis:6379/12
      DATASPECTS_SEARCH_CONFIG_FILE: /usr/dataspectsSoftware/dataspectsSearch_config.yml
      DATASPECTS_PLUGINS_FOLDER: /usr/dataspectsSoftware/PLUGINS
    volumes:
      - dataspects_webservice_customer_data:/usr/dataspectsSoftware
  sidekiq:
    image: 550143289598.dkr.ecr.eu-central-1.amazonaws.com/dataspects-webservice:{{ dockerDataspectsWebserviceVersion }}
    environment:
      REDIS_URL: redis://redis:6379/12
      DATASPECTS_SEARCH_CONFIG_FILE: /usr/dataspectsSoftware/dataspectsSearch_config.yml
      DATASPECTS_PLUGINS_FOLDER: /usr/dataspectsSoftware/PLUGINS
    volumes:
      - dataspects_webservice_customer_data:/usr/dataspectsSoftware
    command: bundle exec sidekiq
volumes:
  mariadb_data:
    driver: local
  mediawiki_root:
    driver: local
  mediawiki_conf:
    driver: local
  nginx_conf:
    driver: local
  # tomcat_root:
  #   driver: local
  esdata:
    driver: local
  dataspects_webservice_customer_data:
    driver: local
